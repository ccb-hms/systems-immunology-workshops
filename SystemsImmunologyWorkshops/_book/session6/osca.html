<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Systems Immunology Workshops - 30&nbsp; Single-cell analysis with Bioconductor</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../session6/pSet6.html" rel="next">
<link href="../session6/session6.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Single-cell analysis with Bioconductor</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Systems Immunology Workshops</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Systems Immunology Workshops</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../preWork/pre_work.html" class="sidebar-item-text sidebar-link">Pre-Work</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../preWork/install.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Installing R and RStudio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../preWork/rstudio.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to RStudio</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../session1/session1.html" class="sidebar-item-text sidebar-link">Session 1: Data Types and Hypothesis Tests</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session1/types.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R Syntax and Data Structures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session1/prob.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Probability Primer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session1/hypo_tests.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Distributions to Hypothesis Tests</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session1/factors.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Categorical Data in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session1/choosing_tests.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Performing and choosing hypothesis tests</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session1/pSet1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Problem Set 1</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../session2/session2.html" class="sidebar-item-text sidebar-link">Session 2: Functions and Multiple Hypothesis Correction</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session2/packages.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Packages and Libraries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session2/loading_functions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Reading data into R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session2/pvals.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">P Values and Multiple Hypotheses</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session2/mult.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Multiple Hypothesis Correction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session2/making_functions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session2/session2problems.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Practice Exercises</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session2/pSet2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Problem Set 2</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../session3/session3.html" class="sidebar-item-text sidebar-link">Session 3: Data Wrangling</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session3/count_data1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Count Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session3/wrangling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Data Wrangling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session3/matching_reordering.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Matching and Reordering Data in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session3/tidyverse.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Tidyverse</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session3/pSet3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Problem Set 3</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../session4/session4.html" class="sidebar-item-text sidebar-link">Session 4: Data visualization in R</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session4/linear_models.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Linear Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session4/ggplot.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Data Visualization in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session4/exporting.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Saving Data and Figures in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session4/other_plots.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Common visualizations in biological analyses</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session4/pSet4.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Problem Set 4</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../session5/session5.html" class="sidebar-item-text sidebar-link">Session 5: Bulk RNA-seq</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session5/summarized_experiment.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Working with summarized experimental data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session5/de_analysis.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Differential expression analysis with DESeq2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session5/enrichment_analysis.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Functional enrichment analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session5/pset5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Problem Set 5</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../session6/session6.html" class="sidebar-item-text sidebar-link">Session 6: scRNA-seq 1</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session6/osca.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Single-cell analysis with Bioconductor</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session6/pSet6.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Problem Set 6</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../resources/resources.html" class="sidebar-item-text sidebar-link">Resources</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../resources/git.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Getting Started with Git &amp; Github</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup"><span class="toc-section-number">30.1</span>  Setup</a></li>
  <li><a href="#analysis-overview-quick-start" id="toc-analysis-overview-quick-start" class="nav-link" data-scroll-target="#analysis-overview-quick-start"><span class="toc-section-number">30.2</span>  Analysis overview (quick start)</a></li>
  <li><a href="#the-singlecellexperiment-data-container" id="toc-the-singlecellexperiment-data-container" class="nav-link" data-scroll-target="#the-singlecellexperiment-data-container"><span class="toc-section-number">30.3</span>  The <code>SingleCellExperiment</code> data container</a></li>
  <li><a href="#data-processing" id="toc-data-processing" class="nav-link" data-scroll-target="#data-processing"><span class="toc-section-number">30.4</span>  Data processing</a>
  <ul class="collapse">
  <li><a href="#quality-control" id="toc-quality-control" class="nav-link" data-scroll-target="#quality-control"><span class="toc-section-number">30.4.1</span>  Quality Control</a></li>
  <li><a href="#normalization" id="toc-normalization" class="nav-link" data-scroll-target="#normalization"><span class="toc-section-number">30.4.2</span>  Normalization</a></li>
  <li><a href="#feature-selection" id="toc-feature-selection" class="nav-link" data-scroll-target="#feature-selection"><span class="toc-section-number">30.4.3</span>  Feature Selection</a></li>
  <li><a href="#dimensionality-reduction" id="toc-dimensionality-reduction" class="nav-link" data-scroll-target="#dimensionality-reduction"><span class="toc-section-number">30.4.4</span>  Dimensionality reduction</a></li>
  <li><a href="#clustering" id="toc-clustering" class="nav-link" data-scroll-target="#clustering"><span class="toc-section-number">30.4.5</span>  Clustering</a></li>
  <li><a href="#marker-gene-detection" id="toc-marker-gene-detection" class="nav-link" data-scroll-target="#marker-gene-detection"><span class="toc-section-number">30.4.6</span>  Marker gene detection</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Single-cell analysis with Bioconductor</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="setup" class="level2" data-number="30.1">
<h2 data-number="30.1" class="anchored" data-anchor-id="setup"><span class="header-section-number">30.1</span> Setup</h2>
<p>The “Orchestrating single-cell analysis with Bioconductor” (<a href="https://bioconductor.org/books/release/OSCA/">OSCA</a>) online book describes common workflows for the analysis of single-cell RNA-seq data (scRNA-seq).</p>
<p>This includes employing a variety of Bioconductor packages for processing, analyzing, visualizing, and exploring scRNA-seq data.</p>
<p>The online book is a companion of the <a href="https://www.nature.com/articles/s41592-019-0654-x">OSCA publication</a>.</p>
<p>As a pre-requisite to this course, we need to install all packages required in the OSCA basic module. This can be conveniently achieved by using the <code>install</code> command from the <a href="https://cran.r-project.org/web/packages/BiocManager/index.html">BiocManager</a> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"OSCA.basic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="analysis-overview-quick-start" class="level2" data-number="30.2">
<h2 data-number="30.2" class="anchored" data-anchor-id="analysis-overview-quick-start"><span class="header-section-number">30.2</span> Analysis overview (quick start)</h2>
<p>In the simplest case, the typical scRNA-seq analysis workflow has the following form:</p>
<ol type="1">
<li>We compute quality control metrics to remove low-quality cells that would interfere with downstream analyses. These cells may have been damaged during processing or may not have been fully captured by the sequencing protocol. Common metrics includes the total counts per cell, the proportion of spike-in or mitochondrial reads and the number of detected features.</li>
<li>We convert the counts into normalized expression values to eliminate cell-specific biases (e.g., in capture efficiency). This allows us to perform explicit comparisons across cells in downstream steps like clustering. We also apply a transformation, typically log, to adjust for the mean-variance relationship.</li>
<li>We perform feature selection to pick a subset of interesting features for downstream analysis. This is done by modelling the variance across cells for each gene and retaining genes that are highly variable. The aim is to reduce computational overhead and noise from uninteresting genes.</li>
<li>We apply dimensionality reduction to compact the data and further reduce noise. Principal components analysis is typically used to obtain an initial low-rank representation for more computational work, followed by more aggressive methods like <span class="math inline">\(t\)</span>-stochastic neighbor embedding for visualization purposes.</li>
<li>We cluster cells into groups according to similarities in their (normalized) expression profiles. This aims to obtain groupings that serve as empirical proxies for distinct biological states. We typically interpret these groupings by identifying differentially expressed marker genes between clusters.</li>
</ol>
<p><img src="files/workflow.png" alt="workflow" width="600"></p>
<p>For demonstration of the typical workflow, we use the a droplet-based mouse retina dataset from <a href="https://doi.org/10.1016/j.cell.2015.05.002">Macosko et al., 2015</a> provided in the <a href="https://bioconductor.org/packages/scRNAseq">scRNAseq</a> package. This starts from a count matrix and finishes with clusters in preparation for biological interpretation.</p>
<p>We start by loading all required packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scRNAseq)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scater)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scran)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then proceed with carrying out the typical workflow steps through a series of designated commands.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain dataset as a SingleCellExperiment</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> <span class="fu">MacoskoRetinaData</span>()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Quality control (using mitochondrial genes)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>is.mito <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"^MT-"</span>, <span class="fu">rownames</span>(sce))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>qcstats <span class="ot">&lt;-</span> <span class="fu">perCellQCMetrics</span>(sce, <span class="at">subsets =</span> <span class="fu">list</span>(<span class="at">Mito =</span> is.mito))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>filtered <span class="ot">&lt;-</span> <span class="fu">quickPerCellQC</span>(qcstats, <span class="at">percent_subsets =</span> <span class="st">"subsets_Mito_percent"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> sce[, <span class="sc">!</span>filtered<span class="sc">$</span>discard]</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalization</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> <span class="fu">logNormCounts</span>(sce)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature selection</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>dec <span class="ot">&lt;-</span> <span class="fu">modelGeneVar</span>(sce)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>hvg <span class="ot">&lt;-</span> <span class="fu">getTopHVGs</span>(dec, <span class="at">prop =</span> <span class="fl">0.1</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimensionality reduction (PCA)</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> <span class="fu">runPCA</span>(sce, <span class="at">ncomponents =</span> <span class="dv">25</span>, <span class="at">subset_row =</span> hvg)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Clustering</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="fu">colLabels</span>(sce) <span class="ot">&lt;-</span> <span class="fu">clusterCells</span>(sce, <span class="at">use.dimred =</span> <span class="st">"PCA"</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                               <span class="at">BLUSPARAM =</span> <span class="fu">NNGraphParam</span>(<span class="at">cluster.fun =</span> <span class="st">"louvain"</span>))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> <span class="fu">runUMAP</span>(sce, <span class="at">dimred =</span> <span class="st">"PCA"</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Marker detection</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>markers <span class="ot">&lt;-</span> <span class="fu">findMarkers</span>(sce, <span class="at">test.type =</span> <span class="st">"wilcox"</span>, <span class="at">direction =</span> <span class="st">"up"</span>, <span class="at">lfc =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-singlecellexperiment-data-container" class="level2" data-number="30.3">
<h2 data-number="30.3" class="anchored" data-anchor-id="the-singlecellexperiment-data-container"><span class="header-section-number">30.3</span> The <code>SingleCellExperiment</code> data container</h2>
<p>One of the main strengths of the <a href="https://bioconductor.org">Bioconductor</a> project lies in the use of a common data infrastructure that powers interoperability across packages. Users should be able to analyze their data using functions from different Bioconductor packages without the need to convert between formats.</p>
<p>To this end, the <code>SingleCellExperiment</code> class (from the <a href="https://bioconductor.org/packages/SingleCellExperiment">SingleCellExperiment</a> package) serves as the common currency for data exchange across 200+ single-cell-related Bioconductor packages. This class implements a data structure that stores all aspects of our single-cell data - gene-by-cell expression data, per-cell metadata and per-gene annotation - and manipulate them in a synchronized manner.</p>
<p><img src="files/SingleCellExperiment.png" alt="SingleCellExperiment" width="600"></p>
<p>We start by loading the package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SingleCellExperiment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we take a peak at the anatomy of a <code>SingleCellExperiment</code> by inspecting the components of the Macosko mouse retina dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>sce</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class: SingleCellExperiment 
dim: 24658 45877 
metadata(0):
assays(2): counts logcounts
rownames(24658): KITL TMTC3 ... 1110059M19RIK GM20861
rowData names(0):
colnames(45877): r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA ... p1_TAACGCGCTCCT
  p1_ATTCTTGTTCTT
colData names(4): cell.id cluster sizeFactor label
reducedDimNames(2): PCA UMAP
mainExpName: NULL
altExpNames(0):</code></pre>
</div>
</div>
<p>Users familiar with the <code>SummarizedExperiment</code> class for storing bulk RNA-seq data will notice the similarity of the <code>SingleCellExperiment</code> class and the <code>SummarizedExperiment</code> class. In fact, the <code>SingleCellExperiment</code> class is a child of the <code>SummarizedExperiment</code> class.</p>
<p>In an object-oriented programming paradigm, this means that the <code>SingleCellExperiment</code> class inherits all methods from the <code>SummarizedExperiment</code> class. In practice, this means that we can work with a <code>SingleCellExperiment</code> very much in the same way that we are used to when working with a <code>SummarizedExperiment</code>.</p>
<p>This includes accessing experimental assay data via the <code>assay</code> acessor function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">assay</span>(sce, <span class="st">"counts"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5 x 5 sparse Matrix of class "dgCMatrix"
              r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA r1_GCGCAACTGCTC r1_GATTGGGAGGCA
KITL                        .               .               1               .
TMTC3                       3               .               .               .
CEP290                      1               3               .               2
4930430F08RIK               2               1               2               .
1700017N19RIK               .               .               .               .
              r1_CCTCCTAGTTGG
KITL                        .
TMTC3                       2
CEP290                      1
4930430F08RIK               1
1700017N19RIK               .</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">assay</span>(sce, <span class="st">"logcounts"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5 x 5 sparse Matrix of class "dgCMatrix"
              r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA r1_GCGCAACTGCTC r1_GATTGGGAGGCA
KITL               .               .                0.0670073       .        
TMTC3              0.14677618      .                .               .        
CEP290             0.05060284      0.17027364       .               0.1781196
4930430F08RIK      0.09949075      0.05901921       0.1310400       .        
1700017N19RIK      .               .                .               .        
              r1_CCTCCTAGTTGG
KITL               .         
TMTC3              0.18501637
CEP290             0.09547205
4930430F08RIK      0.09547205
1700017N19RIK      .         </code></pre>
</div>
</div>
<p>And accessing the cell metadata stored in the <code>colData</code> slot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(sce)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 45877 rows and 4 columns
                        cell.id   cluster sizeFactor    label
                    &lt;character&gt; &lt;integer&gt;  &lt;numeric&gt; &lt;factor&gt;
r1_GGCCGCAGTCCG r1_GGCCGCAGTCCG         2    28.0131        1
r1_CTTGTGCGGGAA r1_CTTGTGCGGGAA         2    23.9479        1
r1_GCGCAACTGCTC r1_GCGCAACTGCTC         2    21.0343        1
r1_GATTGGGAGGCA r1_GATTGGGAGGCA         2    15.2197        1
r1_CCTCCTAGTTGG r1_CCTCCTAGTTGG        NA    14.6167        1
...                         ...       ...        ...      ...
p1_TCAAAAGCCGGG p1_TCAAAAGCCGGG        24   0.610523       13
p1_ATTAAGTTCCAA p1_ATTAAGTTCCAA        34   0.610523       5 
p1_CTGTCTGAGACC p1_CTGTCTGAGACC         2   0.610523       1 
p1_TAACGCGCTCCT p1_TAACGCGCTCCT        24   0.609776       11
p1_ATTCTTGTTCTT p1_ATTCTTGTTCTT        24   0.609776       8 </code></pre>
</div>
</div>
<p>A useful shortcut for accessing variables of the <code>colData</code> is using the <code>$</code> notation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sce<span class="sc">$</span>sizeFactor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA r1_GCGCAACTGCTC r1_GATTGGGAGGCA r1_CCTCCTAGTTGG 
       28.01308        23.94791        21.03429        15.21974        14.61669 
r1_AGTCAAGCCCTC 
       14.33273 </code></pre>
</div>
</div>
<p>In addition to the basic fields inherited from <code>SummarizedExperiment</code>, the <code>SingleCellExperiment</code> also adds single-cell specific fields to the data structure.</p>
<p>Most importantly, the <code>reducedDims</code> slot is specially designed to store reduced dimensionality representations of the primary data obtained by methods such as PCA, <em>t</em>-SNE, and UMAP.</p>
<p>This slot contains a list of numeric matrices of low-reduced representations of the experimental assay data, where the rows represent the columns of the assay data (cells), and columns represent the dimensions. As this slot holds a list, we can store multiple PCA/<em>t</em>-SNE/UMAP results for the same dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reducedDims</span>(sce)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of length 2
names(2): PCA UMAP</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">reducedDim</span>(sce, <span class="st">"PCA"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 45877    25</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reducedDim</span>(sce, <span class="st">"PCA"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      PC1        PC2        PC3       PC4       PC5
r1_GGCCGCAGTCCG -10.39905 0.15677709  0.5330181 -4.540134 -1.018913
r1_CTTGTGCGGGAA -10.34839 0.47533936  0.3780652 -5.105311 -1.619633
r1_GCGCAACTGCTC -10.47332 0.39723149  0.7291247 -4.561465 -1.003403
r1_GATTGGGAGGCA -10.18998 0.08892315 -0.1959918 -4.980799 -1.841600
r1_CCTCCTAGTTGG -10.57438 0.12170276  0.2046049 -4.336352 -1.250160</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">reducedDim</span>(sce, <span class="st">"UMAP"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 45877     2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">reducedDim</span>(sce, <span class="st">"UMAP"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     [,1]     [,2]
r1_GGCCGCAGTCCG -6.866276 5.599598
r1_CTTGTGCGGGAA -6.829534 5.562110
r1_GCGCAACTGCTC -6.916276 5.621826
r1_GATTGGGAGGCA -6.843490 5.564856
r1_CCTCCTAGTTGG -6.872377 5.589969
r1_AGTCAAGCCCTC  4.671948 5.242036</code></pre>
</div>
</div>
<p><em>Exercise</em>: Subset the PCA representation to the first two PCs and store the result in the <code>reducedDims</code> slot under the name <code>PCA2</code>.</p>
</section>
<section id="data-processing" class="level2" data-number="30.4">
<h2 data-number="30.4" class="anchored" data-anchor-id="data-processing"><span class="header-section-number">30.4</span> Data processing</h2>
<section id="quality-control" class="level3" data-number="30.4.1">
<h3 data-number="30.4.1" class="anchored" data-anchor-id="quality-control"><span class="header-section-number">30.4.1</span> Quality Control</h3>
<p>Low-quality libraries in scRNA-seq data can arise from a variety of sources such as cell damage during dissociation or failure in library preparation (e.g.&nbsp;inefficient reverse transcription or PCR amplification).</p>
<p>These usually manifest as “cells” with low total counts, few expressed genes and high mitochondrial or spike-in proportions.</p>
<p>To avoid misleading results in downstream analyses, we need to remove the problematic cells at the start of the analysis. This step is commonly referred to as quality control (QC) on the cells.</p>
<p>Common choices of QC metrics are:</p>
<ul>
<li>library size: defined as the total sum of counts across all relevant features for each cell,</li>
<li>number of expressed features: defined as the number of endogenous genes with non-zero counts for each cell,</li>
<li>proportion of reads mapped to spike-in transcripts: calculated relative to the total count across all features (including spike-ins) for each cell.</li>
</ul>
<p>In the absence of spike-in transcripts, the proportion of reads mapped to genes in the mitochondrial genome can be used. High proportions are indicative of poor-quality cells, presumably because of loss of cytoplasmic RNA from perforated cells. The reasoning is that, in the presence of modest damage, the holes in the cell membrane permit efflux of individual transcript molecules but are too small to allow mitochondria to escape, leading to a relative enrichment of mitochondrial transcripts.</p>
<p>We start by identifying mitochondrial genes in our <code>SingleCellExperiment</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>is.mito <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"^MT-"</span>, <span class="fu">rownames</span>(sce))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(is.mito)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>is.mito
FALSE  TRUE 
24627    31 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(sce)[is.mito]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "MT-TF"   "MT-ND4"  "MT-TV"   "MT-RNR2" "MT-TS2"  "MT-TL2"  "MT-ND5" 
 [8] "MT-ND6"  "MT-TE"   "MT-CYTB" "MT-TT"   "MT-TP"   "MT-TL1"  "MT-ND1" 
[15] "MT-TI"   "MT-TQ"   "MT-TM"   "MT-ND2"  "MT-TW"   "MT-TA"   "MT-TN"  
[22] "MT-TC"   "MT-TY"   "MT-CO1"  "MT-RNR1" "MT-CO2"  "MT-ATP6" "MT-CO3" 
[29] "MT-ND3"  "MT-ND4L" "MT-ATP8"</code></pre>
</div>
</div>
<p>For each cell, we then calculate QC metrics using the <code>perCellQCMetrics</code> function from the <a href="https://bioconductor.org/packages/scater">scater</a> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>qcstats <span class="ot">&lt;-</span> <span class="fu">perCellQCMetrics</span>(sce, <span class="at">subsets =</span> <span class="fu">list</span>(<span class="at">Mito =</span> is.mito))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(qcstats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 6 rows and 6 columns
                      sum  detected subsets_Mito_sum subsets_Mito_detected
                &lt;numeric&gt; &lt;integer&gt;        &lt;numeric&gt;             &lt;integer&gt;
r1_GGCCGCAGTCCG     37487      7243              427                    14
r1_CTTGTGCGGGAA     32047      6933              503                    15
r1_GCGCAACTGCTC     28148      6397              460                    13
r1_GATTGGGAGGCA     20367      5740              326                    11
r1_CCTCCTAGTTGG     19560      5779              264                     9
r1_AGTCAAGCCCTC     19180      5221              253                    12
                subsets_Mito_percent     total
                           &lt;numeric&gt; &lt;numeric&gt;
r1_GGCCGCAGTCCG              1.13906     37487
r1_CTTGTGCGGGAA              1.56957     32047
r1_GCGCAACTGCTC              1.63422     28148
r1_GATTGGGAGGCA              1.60063     20367
r1_CCTCCTAGTTGG              1.34969     19560
r1_AGTCAAGCCCTC              1.31908     19180</code></pre>
</div>
</div>
<p>The <code>sum</code> column contains the total count for each cell (library size). The <code>detected</code> column contains the number of detected genes (number of expressed features). The <code>subsets_Mito_percent</code> column contains the percentage of reads mapped to mitochondrial transcripts (proportion of reads mapped to mitochondrial genome).</p>
<p>We then identify low-quality cells as outliers for these frequently used QC metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>filtered <span class="ot">&lt;-</span> <span class="fu">quickPerCellQC</span>(qcstats, <span class="at">percent_subsets =</span> <span class="st">"subsets_Mito_percent"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 6 rows and 4 columns
      low_lib_size   low_n_features high_subsets_Mito_percent   discard
  &lt;outlier.filter&gt; &lt;outlier.filter&gt;          &lt;outlier.filter&gt; &lt;logical&gt;
1            FALSE            FALSE                     FALSE     FALSE
2            FALSE            FALSE                     FALSE     FALSE
3            FALSE            FALSE                     FALSE     FALSE
4            FALSE            FALSE                     FALSE     FALSE
5            FALSE            FALSE                     FALSE     FALSE
6            FALSE            FALSE                     FALSE     FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(filtered<span class="sc">$</span>discard)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
FALSE  TRUE 
45007   870 </code></pre>
</div>
</div>
<p>And eventually remove the identified low-quality cells from our <code>SingleCellExperiment</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> sce[,<span class="sc">!</span>filtered<span class="sc">$</span>discard]</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>sce</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class: SingleCellExperiment 
dim: 24658 45007 
metadata(0):
assays(2): counts logcounts
rownames(24658): KITL TMTC3 ... 1110059M19RIK GM20861
rowData names(0):
colnames(45007): r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA ... p1_TAACGCGCTCCT
  p1_ATTCTTGTTCTT
colData names(4): cell.id cluster sizeFactor label
reducedDimNames(2): PCA UMAP
mainExpName: NULL
altExpNames(0):</code></pre>
</div>
</div>
<p><em>Exercise</em>:</p>
<p>A useful diagnostic involves plotting the proportion of mitochondrial counts against some of the other QC metrics. The aim is to confirm that there are no cells with eg. both large total counts and large mitochondrial counts, to ensure that we are not inadvertently removing high-quality cells that happen to be highly metabolically active (e.g., hepatocytes).</p>
<p>Create a plot of library size (<em>x</em>-axis) against percentage of reads mapped to mitochondrial transcripts (<em>y</em>-axis). Color each point/cell by QC status, ie. whether the cell is kept or discarded from further analysis.</p>
<p>Do you observe any cells in the top-right corner of the plot? To what kind of cells might these correspond to?</p>
</section>
<section id="normalization" class="level3" data-number="30.4.2">
<h3 data-number="30.4.2" class="anchored" data-anchor-id="normalization"><span class="header-section-number">30.4.2</span> Normalization</h3>
<p>Systematic differences in sequencing coverage between libraries are often observed in single-cell RNA sequencing data. They typically arise from technical differences in cDNA capture or PCR amplification efficiency across cells Normalization aims to remove these differences such that they do not interfere with comparisons of the expression profiles between cells.</p>
<p>Here, we focus on scaling normalization, which is the simplest and most commonly used class of normalization strategies. This involves dividing all counts for each cell by a cell-specific scaling factor, often called a “size factor”.</p>
<p>We use the <code>logNormCounts</code> function from the <a href="https://bioconductor.org/packages/scater">scater</a> package to compute normalized expression values for each cell. This is done by dividing the count for each gene with the appropriate size factor for that cell. The function also log-transforms the normalized values, creating a new assay called <code>"logcounts"</code>. (Technically, these are “log-transformed normalized expression values”, but that’s too much of a mouthful to fit into the assay name.) These log-values will be the basis for all subsequent analyses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> <span class="fu">logNormCounts</span>(sce)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>sce</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class: SingleCellExperiment 
dim: 24658 45007 
metadata(0):
assays(2): counts logcounts
rownames(24658): KITL TMTC3 ... 1110059M19RIK GM20861
rowData names(0):
colnames(45007): r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA ... p1_TAACGCGCTCCT
  p1_ATTCTTGTTCTT
colData names(4): cell.id cluster sizeFactor label
reducedDimNames(2): PCA UMAP
mainExpName: NULL
altExpNames(0):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">assay</span>(sce, <span class="st">"logcounts"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5 x 5 sparse Matrix of class "dgCMatrix"
              r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA r1_GCGCAACTGCTC r1_GATTGGGAGGCA
KITL               .               .               0.06766381       .        
TMTC3              0.14817513      .               .                .        
CEP290             0.05110146      0.17188351      .                0.1797992
4930430F08RIK      0.10045461      0.05959906      0.13229578       .        
1700017N19RIK      .               .               .                .        
              r1_CCTCCTAGTTGG
KITL               .         
TMTC3              0.18675681
CEP290             0.09639826
4930430F08RIK      0.09639826
1700017N19RIK      .         </code></pre>
</div>
</div>
</section>
<section id="feature-selection" class="level3" data-number="30.4.3">
<h3 data-number="30.4.3" class="anchored" data-anchor-id="feature-selection"><span class="header-section-number">30.4.3</span> Feature Selection</h3>
<p>Procedures like clustering and dimensionality reduction compare cells based on their gene expression profiles, which involves aggregating per-gene differences into a single (dis)similarity metric between a pair of cells. The choice of genes to use in this calculation has a major impact on the behavior of the metric and the performance of downstream methods. We want to select genes that contain useful information about the biology of the system while removing genes that contain random noise.</p>
<p>The simplest approach to quantifying per-gene variation is to compute the variance of the log-normalized expression values (i.e., “log-counts” ) for each gene across all cells.</p>
<p>Calculation of the per-gene variance is simple but feature selection requires modelling of the mean-variance relationship. The log-transformation is not a variance stabilizing transformation in most cases, which means that the total variance of a gene is driven more by its abundance than its underlying biological heterogeneity. To account for this effect, we use the <code>modelGeneVar()</code> function to fit a trend to the variance with respect to abundance across all genes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>dec <span class="ot">&lt;-</span> <span class="fu">modelGeneVar</span>(sce)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 6 rows and 6 columns
                     mean       total        tech          bio   p.value
                &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;    &lt;numeric&gt; &lt;numeric&gt;
KITL          0.008831083 0.011817944 0.011539348  2.78597e-04 0.4197562
TMTC3         0.052015623 0.076252434 0.067542702  8.70973e-03 0.1397003
CEP290        0.584435308 0.848403065 0.694966178  1.53437e-01 0.0320153
4930430F08RIK 0.053338509 0.069822873 0.069247222  5.75650e-04 0.4722040
1700017N19RIK 0.000483115 0.000554535 0.000632043 -7.75074e-05 0.8481758
MGAT4C        0.017340314 0.017807378 0.022630098 -4.82272e-03 0.9630805
                    FDR
              &lt;numeric&gt;
KITL           1.000000
TMTC3          1.000000
CEP290         0.561275
4930430F08RIK  1.000000
1700017N19RIK  1.000000
MGAT4C         1.000000</code></pre>
</div>
</div>
<p>Visualize the fit:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">metadata</span>(dec)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit<span class="sc">$</span>mean, fit<span class="sc">$</span>var, </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Mean of log-expression"</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Variance of log-expression"</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(fit<span class="sc">$</span><span class="fu">trend</span>(x), <span class="at">col =</span> <span class="st">"dodgerblue"</span>, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="osca_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>At any given abundance, we assume that the variation in expression for most genes is driven by uninteresting processes like sampling noise. Under this assumption, the fitted value of the trend at any given gene’s abundance represents an estimate of its uninteresting variation, which we call the technical component. We then define the biological component for each gene as the difference between its total variance and the technical component. This biological component represents the “interesting” variation for each gene and can be used as the metric for HVG selection.</p>
<p>Ordering by most interesting genes for inspection:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="fu">order</span>(dec<span class="sc">$</span>bio, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>dec[ind,] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 24658 rows and 6 columns
              mean     total      tech       bio     p.value         FDR
         &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;
RHO        3.41544   3.70486  2.449493  1.255363 8.58129e-06 5.74035e-04
CALM1      1.41066   2.32639  1.429140  0.897252 6.95943e-08 7.40731e-06
MEG3       0.87202   1.74991  0.971127  0.778785 8.67190e-12 2.03603e-09
GNGT1      3.21210   3.36933  2.605432  0.763893 6.95946e-03 1.76739e-01
SAG        3.21467   3.25067  2.603463  0.647204 1.85236e-02 3.81431e-01
...            ...       ...       ...       ...         ...         ...
H3F3B      1.49969   1.15205   1.51999 -0.367942    0.978848           1
HMGN1      1.90893   1.52887   1.98657 -0.457699    0.973358           1
HSP90AA1   1.78344   1.30193   1.81992 -0.517984    0.991517           1
MT-CYTB    2.08174   1.57470   2.22196 -0.647268    0.992727           1
MT-RNR2    3.45614   1.20942   2.42701 -1.217592    0.999987           1</code></pre>
</div>
</div>
<p>Once we have quantified the per-gene variation, the next step is to select the subset of HVGs to use in downstream analyses. The most obvious selection strategy is to take the top <em>n</em> genes with the largest values for the relevant variance metric.</p>
<p>Here, we select the top 10% of genes with the highest biological components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>hvg <span class="ot">&lt;-</span> <span class="fu">getTopHVGs</span>(dec, <span class="at">prop =</span> <span class="fl">0.1</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(hvg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 905</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hvg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "RHO"   "CALM1" "MEG3"  "GNGT1" "SAG"   "TRPM1"</code></pre>
</div>
</div>
</section>
<section id="dimensionality-reduction" class="level3" data-number="30.4.4">
<h3 data-number="30.4.4" class="anchored" data-anchor-id="dimensionality-reduction"><span class="header-section-number">30.4.4</span> Dimensionality reduction</h3>
<p>Dimensionality reduction aims to reduce the number of separate dimensions in the data. This is possible because different genes are correlated if they are affected by the same biological process. Thus, we do not need to store separate information for individual genes, but can instead compress multiple features into a single dimension. This reduces computational work in downstream analyses like clustering, as calculations only need to be performed for a few dimensions rather than thousands of genes.</p>
<section id="principal-components-analysis-pca" class="level4" data-number="30.4.4.1">
<h4 data-number="30.4.4.1" class="anchored" data-anchor-id="principal-components-analysis-pca"><span class="header-section-number">30.4.4.1</span> Principal components analysis (PCA)</h4>
<p>Principal components analysis (PCA) discovers axes in high-dimensional space that capture the largest amount of variation. In the context of scRNA-seq, our assumption is that biological processes affect multiple genes in a coordinated manner. This means that the earlier PCs are likely to represent biological structure as more variation can be captured by considering the correlated behavior of many genes.</p>
<p>This motivates the use of the earlier PCs in our downstream analyses, which concentrates the biological signal to simultaneously reduce computational work and remove noise.</p>
<p>Here, we restrict the PCA to the highly-variable genes and retain the top 25 PCs for further analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> <span class="fu">runPCA</span>(sce, <span class="at">ncomponents =</span> <span class="dv">25</span>, <span class="at">subset_row =</span> hvg)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> <span class="fu">reducedDim</span>(sce, <span class="st">"PCA"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(pca)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 45007    25</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>pca[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      PC1        PC2        PC3      PC4       PC5
r1_GGCCGCAGTCCG -10.47089 0.16970918 -0.4811100 4.696597 0.9206715
r1_CTTGTGCGGGAA -10.42688 0.47419951 -0.3144957 5.307922 1.4892991
r1_GCGCAACTGCTC -10.54620 0.39601153 -0.6531475 4.737640 0.9271435
r1_GATTGGGAGGCA -10.26394 0.09917153  0.2666505 5.175493 1.6992644
r1_CCTCCTAGTTGG -10.61930 0.09928218 -0.1348716 4.507015 1.1091080</code></pre>
</div>
</div>
<p><em>Exercise</em>:</p>
<p>Subset the <code>SingleCellExperiment</code> to all cells assigned to the first ten clusters by the authors of the mouse retina study (stored in the <code>colData</code> variable <code>cluster</code>). For the resulting object, plot the first two PCs and color each cell based on cluster membership using <code>ggplot2</code>.</p>
<p>Hint: see also the <code>plotReducedDim</code> function from the <a href="https://bioconductor.org/packages/scater">scater</a> package.</p>
</section>
<section id="non-linear-methods-for-visualization-t-sne-umap" class="level4" data-number="30.4.4.2">
<h4 data-number="30.4.4.2" class="anchored" data-anchor-id="non-linear-methods-for-visualization-t-sne-umap"><span class="header-section-number">30.4.4.2</span> Non-linear methods for visualization (<em>t</em>-SNE / UMAP)</h4>
<p>The de facto standard for visualization of scRNA-seq data is the <em>t</em>-stochastic neighbor embedding (<em>t</em>-SNE) method (<a href="https://www.jmlr.org/papers/volume9/vandermaaten08a/vandermaaten08a.pdf">Van der Maaten and Hinton 2008</a>). This attempts to find a low-dimensional representation of the data that preserves the distances between each point and its neighbors in the high-dimensional space. Unlike PCA, it is not restricted to linear transformations, nor is it obliged to accurately represent distances between distant populations. This means that it has much more freedom in how it arranges cells in low-dimensional space, enabling it to separate many distinct clusters in a complex population.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>sce.sub <span class="ot">&lt;-</span> <span class="fu">subset</span>(sce, , cluster <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>sce.sub <span class="ot">&lt;-</span> <span class="fu">runTSNE</span>(sce.sub, <span class="at">dimred =</span> <span class="st">"PCA"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>sce.sub<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">factor</span>(sce.sub<span class="sc">$</span>cluster, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(sce.sub, <span class="st">"TSNE"</span>, <span class="at">color_by =</span> <span class="st">"cluster"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="osca_files/figure-html/tsne-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It is unwise to read too much into the relative sizes and positions of the visual clusters. <em>t</em>-SNE will inflate dense clusters and compress sparse ones, such that we cannot use the size as a measure of subpopulation heterogeneity. In addition, <em>t</em>-SNE is not obliged to preserve the relative locations of non-neighboring clusters, such that we cannot use their positions to determine relationships between distant clusters.</p>
<p>The uniform manifold approximation and projection (UMAP) method (<a href="https://arxiv.org/abs/1802.03426">McInnes, Healy, and Melville 2018</a>) is an alternative to <em>t</em>-SNE for non-linear dimensionality reduction. It is roughly similar to <em>t</em>-SNE in that it also tries to find a low-dimensional representation that preserves relationships between neighbors in high-dimensional space. However, the two methods are based on different theory, represented by differences in the various graph weighting equations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>sce.sub <span class="ot">&lt;-</span> <span class="fu">runUMAP</span>(sce.sub, <span class="at">dimred =</span> <span class="st">"PCA"</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(sce.sub, <span class="st">"UMAP"</span>, <span class="at">color_by =</span> <span class="st">"cluster"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="osca_files/figure-html/umap-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Compared to <em>t</em>-SNE, the UMAP visualization tends to have more compact visual clusters with more empty space between them. It also attempts to preserve more of the global structure than <em>t</em>-SNE. From a practical perspective, UMAP is much faster than <em>t</em>-SNE, which may be an important consideration for large datasets. UMAP plots are therefore increasingly displacing <em>t</em>-SNE plots as the method of choice for visualizing large scRNA-seq data sets.</p>
<p>See also the <a href="http://bioconductor.org/books/3.16/OSCA.basic/dimensionality-reduction.html#visualization-interpretation">dedicated section</a> on interpreting guidelines for <em>t</em>-SNE and UMAP plots in the OSCA book.</p>
</section>
</section>
<section id="clustering" class="level3" data-number="30.4.5">
<h3 data-number="30.4.5" class="anchored" data-anchor-id="clustering"><span class="header-section-number">30.4.5</span> Clustering</h3>
<p>Clustering is an unsupervised learning procedure that is used to empirically define groups of cells with similar expression profiles. Its primary purpose is to summarize complex scRNA-seq data into a digestible format for human interpretation. This allows us to describe population heterogeneity in terms of discrete labels that are easily understood, rather than attempting to comprehend the high-dimensional manifold on which the cells truly reside. After annotation based on marker genes, the clusters can be treated as proxies for more abstract biological concepts such as cell types or states.</p>
<p>Popularized by its use in <a href="https://cran.r-project.org/web/packages/Seurat/index.html">Seurat</a>, graph-based clustering is a flexible and scalable technique for clustering large scRNA-seq datasets. We first build a graph where each node is a cell that is connected to its nearest neighbors in the high-dimensional space. Edges are weighted based on the similarity between the cells involved, with higher weight given to cells that are more closely related. We then apply algorithms to identify “communities” of cells that are more connected to cells in the same community than they are to cells of different communities. Each community represents a cluster that we can use for downstream interpretation.</p>
<p>Here, we use the <code>clusterCells()</code> function from the <a href="https://bioconductor.org/packages/scran">scran</a> package to perform graph-based clustering using the <a href="https://doi.org/10.1088/1742-5468/2008/10/P10008">Louvain algorithm</a> for community detection. All calculations are performed using the top PCs to take advantage of data compression and denoising. This function returns a vector containing cluster assignments for each cell in our <code>SingleCellExperiment</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colLabels</span>(sce) <span class="ot">&lt;-</span> <span class="fu">clusterCells</span>(sce, <span class="at">use.dimred =</span> <span class="st">"PCA"</span>,</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">BLUSPARAM =</span> <span class="fu">NNGraphParam</span>(<span class="at">cluster.fun =</span> <span class="st">"louvain"</span>))</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">colLabels</span>(sce))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   1    2    3    4    5    6    7    8    9   10   11   12   13 
3479 2517  181 4168 1851 2573  198 7293  480 2840 5422 5107 8898 </code></pre>
</div>
</div>
<p>We assign the cluster assignments back into our <code>SingleCellExperiment</code> object as a <code>factor</code> in the column metadata. This allows us to conveniently visualize the distribution of clusters in eg. a <em>t</em>-SNE or a UMAP.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>sce <span class="ot">&lt;-</span> <span class="fu">runUMAP</span>(sce, <span class="at">dimred =</span> <span class="st">"PCA"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(sce, <span class="st">"UMAP"</span>, <span class="at">color_by =</span> <span class="st">"label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="osca_files/figure-html/cluster-viz-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Exercise:</strong> The <a href="https://www.nature.com/articles/s41598-019-41695-z">Leiden algorithm</a> is similar to the Louvain algorithm, but it is faster and has been shown to result in better connected communities. Modify the above call to <code>clusterCells</code> to carry out the community detection with the Leiden algorithm instead. Visualize the results in a UMAP plot.</p>
<p>Hint: The <code>NNGraphParam</code> constructor has an argument <code>cluster.args</code>. This allows to specify arguments passed on to the <code>cluster_leiden</code> function from the <a href="https://cran.r-project.org/web/packages/igraph/index.html">igraph</a> package. Use the <code>cluster.args</code> argument to parameterize the clustering to use modularity as the objective function and a resolution parameter of 0.5.</p>
</section>
<section id="marker-gene-detection" class="level3" data-number="30.4.6">
<h3 data-number="30.4.6" class="anchored" data-anchor-id="marker-gene-detection"><span class="header-section-number">30.4.6</span> Marker gene detection</h3>
<p>To interpret clustering results as obtained in the previous section, we identify the genes that drive separation between clusters. These marker genes allow us to assign biological meaning to each cluster based on their functional annotation. In the simplest case, we have <em>a priori</em> knowledge of the marker genes associated with particular cell types, allowing us to treat the clustering as a proxy for cell type identity.</p>
<p>The most straightforward approach to marker gene detection involves testing for differential expression between clusters. If a gene is strongly DE between clusters, it is likely to have driven the separation of cells in the clustering algorithm.</p>
<p>Here, we perform a Wilcoxon rank sum test against a log2 fold change threshold of 1, focusing on up-regulated (positive) markers in one cluster when compared to another cluster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>markers <span class="ot">&lt;-</span> <span class="fu">findMarkers</span>(sce, <span class="at">test.type =</span> <span class="st">"wilcox"</span>, <span class="at">direction =</span> <span class="st">"up"</span>, <span class="at">lfc =</span> <span class="dv">1</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>markers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of length 13
names(13): 1 2 3 4 5 6 7 8 9 10 11 12 13</code></pre>
</div>
</div>
<p>The resulting object contains a sorted marker gene list for each cluster, in which the top genes are those that contribute the most to the separation of that cluster from mall other clusters.</p>
<p>Here, we inspect the ranked marker gene list for the first cluster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>markers[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 24658 rows and 16 columns
                    Top      p.value          FDR summary.AUC     AUC.2
              &lt;integer&gt;    &lt;numeric&gt;    &lt;numeric&gt;   &lt;numeric&gt; &lt;numeric&gt;
MEG3                  1  0.00000e+00  0.00000e+00    0.888463  0.845977
TUBA1A                1  9.44436e-93  1.55253e-89    0.618491  0.475081
SNHG11                1  0.00000e+00  0.00000e+00    0.739359  0.746507
SYT1                  2 1.39150e-257 4.28896e-254    0.787200  0.445947
CALM1                 2  0.00000e+00  0.00000e+00    0.819012  0.641825
...                 ...          ...          ...         ...       ...
VSIG1             24653            1            1           0         0
GM16390           24654            1            1           0         0
GM25207           24655            1            1           0         0
1110059M19RIK     24656            1            1           0         0
GM20861           24657            1            1           0         0
                  AUC.3     AUC.4     AUC.5     AUC.6     AUC.7     AUC.8
              &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;
MEG3          0.6823435  0.452022  0.806585  0.478549 0.1814640  0.888463
TUBA1A        0.1177991  0.314720  0.425543  0.291106 0.4608110  0.551061
SNHG11        0.0780595  0.552940  0.742181  0.705132 0.0224885  0.742499
SYT1          0.5334295  0.312969  0.787200  0.306610 0.0587842  0.558274
CALM1         0.1535273  0.382751  0.720211  0.427866 0.0121595  0.790286
...                 ...       ...       ...       ...       ...       ...
VSIG1                 0         0         0         0         0         0
GM16390               0         0         0         0         0         0
GM25207               0         0         0         0         0         0
1110059M19RIK         0         0         0         0         0         0
GM20861               0         0         0         0         0         0
                  AUC.9     AUC.10    AUC.11    AUC.12    AUC.13
              &lt;numeric&gt;  &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;
MEG3           0.851448 0.48777190  0.868714  0.876063  0.868428
TUBA1A         0.510270 0.33683924  0.557312  0.568311  0.618491
SNHG11         0.747063 0.74284864  0.739116  0.746561  0.739359
SYT1           0.824606 0.39838052  0.574880  0.574974  0.636706
CALM1          0.441906 0.00711705  0.753439  0.831255  0.819012
...                 ...        ...       ...       ...       ...
VSIG1                 0          0         0         0         0
GM16390               0          0         0         0         0
GM25207               0          0         0         0         0
1110059M19RIK         0          0         0         0         0
GM20861               0          0         0         0         0</code></pre>
</div>
</div>
<p>The <code>Top</code> field provides the the minimum rank across all pairwise comparisons. The <code>p.value</code> field provides the combined <em>p</em>-value across all comparisons, and the <code>FDR</code> field the BH-adjusted <em>p</em>-value for each gene. The <code>summary.AUC</code> provides area under the curve (here the concordance probability) from the comparison with the lowest <em>p</em>-value, the <code>AUC.n</code> fields provide the AUC for each pairwise comparison. The AUC is the probability that a randomly selected cell in cluster <em>A</em> has a greater expression of gene <em>X</em> than a randomly selected cell in <em>B</em>.</p>
<p>We can then inspect the top marker genes for the first cluster using the <code>plotExpression</code> function from the <a href="https://bioconductor.org/packages/scater">scater</a> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>top.markers <span class="ot">&lt;-</span> <span class="fu">head</span>(<span class="fu">rownames</span>(markers[[<span class="dv">1</span>]]))</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotExpression</span>(sce, <span class="at">features =</span> top.markers, <span class="at">x =</span> <span class="st">"label"</span>, <span class="at">color_by =</span> <span class="st">"label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="osca_files/figure-html/plot-markers-1.png" class="img-fluid" width="960"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../session6/session6.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Session 6: scRNA-seq 1</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../session6/pSet6.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Problem Set 6</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>